<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TinyServe dashboard</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #7c3aed;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --card: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(14,165,233,0.08));
      --border: rgba(255,255,255,0.06);
      --success: #22c55e;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "SF Pro Display", "Inter", "Helvetica Neue", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(124,58,237,0.12), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(14,165,233,0.18), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 24px 56px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 22px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(120deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow: 0 24px 60px rgba(0,0,0,0.25);
    }
    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.02em;
    }
    .title p {
      margin: 0;
      color: var(--muted);
    }
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      font-size: 13px;
      color: var(--muted);
    }
    .user-info .email {
      color: var(--text);
    }
    button {
      cursor: pointer;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
      background: var(--accent);
      color: #f8fafc;
      font-weight: 600;
      letter-spacing: -0.01em;
      box-shadow: 0 10px 32px rgba(124,58,237,0.35);
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button:active { transform: translateY(1px); box-shadow: 0 6px 20px rgba(124,58,237,0.25); }
    .section {
      margin-top: 24px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      padding: 18px 18px 12px;
      box-shadow: 0 22px 50px rgba(0,0,0,0.2);
    }
    .section h2 {
      margin: 4px 0 12px;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(17,24,39,0.7);
      padding: 12px 14px;
    }
    .metric {
      font-size: 28px;
      font-weight: 700;
    }
    .metric.ok { color: var(--success); }
    .metric.warn { color: var(--warning); }
    .label {
      color: var(--muted);
      font-size: 13px;
      margin-top: 2px;
    }
    .muted { color: var(--muted); }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
    }
    a.badge {
      color: inherit;
      text-decoration: none;
    }
    .host-link {
      color: var(--muted);
      text-decoration: none;
    }
    .host-link:hover {
      color: #93c5fd;
      text-decoration: underline;
    }
    .badge.ok { color: var(--success); border-color: rgba(34,197,94,0.5); }
    .badge.warn { color: var(--warning); border-color: rgba(245,158,11,0.5); }
    .services {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 6px;
    }
    .service {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(17,24,39,0.8);
      padding: 14px;
    }
    .service h3 {
      margin: 0 0 6px;
      font-size: 17px;
      letter-spacing: -0.01em;
    }
    .service-actions {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .action-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .btn-secondary {
      background: rgba(15,23,42,0.6);
      border-color: rgba(148,163,184,0.2);
      color: #e2e8f0;
      box-shadow: none;
    }
    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .action-note {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .action-status {
      font-size: 12px;
      color: var(--muted);
    }
    .action-status.ok { color: var(--success); }
    .action-status.warn { color: #fca5a5; }
    .pill-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .inline-muted { color: var(--muted); font-size: 13px; }
    .empty {
      text-align: center;
      color: var(--muted);
      padding: 24px 12px;
    }
    .error {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(248,113,113,0.5);
      background: rgba(248,113,113,0.08);
      color: #fecdd3;
      display: none;
    }
    .log-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .tag-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag-label {
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .tag-list {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .tag {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(17,24,39,0.8);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }
    .tag.active {
      border-color: rgba(59,130,246,0.7);
      color: #bfdbfe;
      background: rgba(59,130,246,0.22);
    }
    .tail-controls {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tail-label {
      color: var(--muted);
      font-size: 12px;
    }
    select,
    input[type="number"] {
      background: rgba(17,24,39,0.8);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
    }
    .logs-output {
      background: rgba(2,6,23,0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-height: 120px;
      max-height: 320px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .tail-buttons {
      display: flex;
      gap: 4px;
    }
    .tail-btn {
      background: rgba(17,24,39,0.8);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    .tail-btn.active {
      background: rgba(99, 102, 241, 0.3);
      border-color: rgba(99, 102, 241, 0.6);
    }
    .tail-btn:hover {
      background: rgba(99, 102, 241, 0.2);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title">
        <h1>tinyserve</h1>
        <p>Local Mac mini host — Traefik + cloudflared front door</p>
      </div>
      <div class="actions">
        <div id="user-info" class="user-info" style="display: none;"></div>
        <button id="refresh">Refresh</button>
      </div>
    </header>

    <div class="section">
      <h2>Daemon status</h2>
      <div class="grid">
        <div class="card">
          <div class="metric" id="status-text">—</div>
          <div class="label">Status</div>
          <div class="inline-muted" id="status-detail" style="display: none;"></div>
        </div>
        <div class="card">
          <div class="metric" id="service-count">0</div>
          <div class="label">Services tracked</div>
        </div>
        <div class="card">
          <div class="metric" id="updated-at">—</div>
          <div class="label">Last state update</div>
        </div>
        <div class="card">
          <div class="metric" id="cpu-usage">—</div>
          <div class="label">CPU usage</div>
        </div>
        <div class="card">
          <div class="metric" id="memory-usage">—</div>
          <div class="label">Memory usage</div>
          <div class="inline-muted" id="memory-detail">—</div>
        </div>
        <div class="card">
          <div class="metric" id="tunnel-status">—</div>
          <div class="label">cloudflared</div>
          <div class="inline-muted" id="tunnel-health">—</div>
        </div>
        <div class="card">
          <div class="metric" id="uptime">—</div>
          <div class="label">Uptime</div>
        </div>
        <div class="card">
          <div class="metric" id="free-disk">—</div>
          <div class="label">Free disk</div>
        </div>
      </div>
      <div class="error" id="status-error"></div>
    </div>

    <div class="section">
      <h2>Services</h2>
      <div id="services" class="services"></div>
      <div class="error" id="services-error"></div>
    </div>

    <div class="section">
      <h2>Logs</h2>
      <div class="log-controls">
        <div class="tag-group">
          <div class="tag-label">Access</div>
          <div id="access-tags" class="tag-list"></div>
        </div>
        <div class="tag-group">
          <div class="tag-label">Containers</div>
          <div id="container-tags" class="tag-list"></div>
        </div>
        <div class="tail-controls">
          <div class="tail-label">Last <span id="tail-count">200</span> lines</div>
          <button id="load-earlier" class="tail-btn">Load earlier</button>
        </div>
      </div>
      <pre id="logs-output" class="logs-output">Select a log source.</pre>
      <div class="error" id="logs-error"></div>
    </div>
  </div>

  <script>
    const statusText = document.getElementById("status-text");
    const statusDetail = document.getElementById("status-detail");
    const serviceCount = document.getElementById("service-count");
    const updatedAt = document.getElementById("updated-at");
    const servicesContainer = document.getElementById("services");
    const statusError = document.getElementById("status-error");
    const servicesError = document.getElementById("services-error");
    const cpuUsageEl = document.getElementById("cpu-usage");
    const memoryUsageEl = document.getElementById("memory-usage");
    const memoryDetailEl = document.getElementById("memory-detail");
    const tunnelStatus = document.getElementById("tunnel-status");
    const tunnelHealth = document.getElementById("tunnel-health");
    const uptimeEl = document.getElementById("uptime");
    const freeDiskEl = document.getElementById("free-disk");
    const accessTags = document.getElementById("access-tags");
    const containerTags = document.getElementById("container-tags");
    const tailCountEl = document.getElementById("tail-count");
    const loadEarlierBtn = document.getElementById("load-earlier");
    const logsOutput = document.getElementById("logs-output");
    const logsError = document.getElementById("logs-error");
    let currentTail = 200;
    let currentLogSource = "ui";

    async function fetchJSON(path, options = {}) {
      const opts = options || {};
      const headers = { ...(opts.headers || {}) };
      if (opts.body && !headers["Content-Type"]) {
        headers["Content-Type"] = "application/json";
      }
      const res = await fetch(path, { cache: "no-store", ...opts, headers });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || res.statusText);
      }
      const text = await res.text();
      if (!text) return {};
      try {
        return JSON.parse(text);
      } catch (err) {
        return text;
      }
    }

    function renderStatus(data) {
      statusText.textContent = data.status || "unknown";
      statusText.className = data.status === "ok" ? "metric ok" : "metric warn";
      if (data.status_detail) {
        statusDetail.textContent = data.status_detail;
        statusDetail.style.display = "block";
      } else {
        statusDetail.textContent = "";
        statusDetail.style.display = "none";
      }
      serviceCount.textContent = data.service_count ?? 0;
      if (data.updated_at) {
        const updatedDate = new Date(data.updated_at);
        updatedAt.textContent = formatRelativeTime(updatedDate);
        updatedAt.title = updatedDate.toLocaleString();
      } else {
        updatedAt.textContent = "—";
        updatedAt.title = "";
      }

      const tunnel = data.tunnel || {};
      tunnelStatus.textContent = tunnel.state || "unknown";
      tunnelStatus.className = isHealthy(tunnel) ? "metric ok" : "metric warn";
      tunnelHealth.textContent = tunnel.health || "";

      if (data.cpu_percent != null) {
        cpuUsageEl.textContent = formatPercent(data.cpu_percent);
      } else {
        cpuUsageEl.textContent = "—";
      }

      if (data.memory_used_percent != null) {
        memoryUsageEl.textContent = formatPercent(data.memory_used_percent);
      } else {
        memoryUsageEl.textContent = "—";
      }
      if (data.memory_used_bytes != null && data.memory_total_bytes != null) {
        memoryDetailEl.textContent = `${formatBytes(data.memory_used_bytes)} / ${formatBytes(data.memory_total_bytes)}`;
      } else {
        memoryDetailEl.textContent = "—";
      }

      uptimeEl.textContent = data.uptime_seconds != null ? formatUptime(data.uptime_seconds) : "—";
      freeDiskEl.textContent = data.free_disk_bytes != null ? formatBytes(data.free_disk_bytes) : "—";
    }

    function formatUptime(seconds) {
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (d > 0) return `${d}d ${h}h`;
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      return (bytes / (1024 * 1024 * 1024)).toFixed(1) + " GB";
    }

    function formatPercent(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return "—";
      if (num < 1) return num.toFixed(1) + "%";
      if (num < 10) return num.toFixed(1) + "%";
      return Math.round(num) + "%";
    }

    function formatRelativeTime(date) {
      const now = Date.now();
      const diffMs = date.getTime() - now;
      const diffSec = Math.round(diffMs / 1000);
      const absSec = Math.abs(diffSec);
      const units = [
        { limit: 60, value: 1, name: "second" },
        { limit: 60 * 60, value: 60, name: "minute" },
        { limit: 60 * 60 * 24, value: 60 * 60, name: "hour" },
        { limit: 60 * 60 * 24 * 7, value: 60 * 60 * 24, name: "day" },
        { limit: 60 * 60 * 24 * 30, value: 60 * 60 * 24 * 7, name: "week" },
        { limit: 60 * 60 * 24 * 365, value: 60 * 60 * 24 * 30, name: "month" },
        { limit: Infinity, value: 60 * 60 * 24 * 365, name: "year" },
      ];
      const unit = units.find((entry) => absSec < entry.limit) || units[units.length - 1];
      const value = Math.round(diffSec / unit.value);
      if (value === 0) return "just now";
      const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: "auto" });
      return rtf.format(value, unit.name);
    }

    function hostToUrl(host) {
      if (!host) return "";
      const lower = host.toLowerCase();
      const isLocal = lower === "localhost" || lower.endsWith(".local") || /^[0-9.]+$/.test(lower);
      const scheme = isLocal ? "http" : "https";
      return `${scheme}://${host}`;
    }

    function buildPurgeSection(service) {
      if (!service || !service.cloudflare) return null;

      const actions = document.createElement("div");
      actions.className = "service-actions";

      const row = document.createElement("div");
      row.className = "action-row";

      const purgeBtn = document.createElement("button");
      purgeBtn.type = "button";
      purgeBtn.className = "btn-secondary";
      purgeBtn.textContent = "Purge Cache";

      const statusEl = document.createElement("div");
      statusEl.className = "action-status";

      purgeBtn.addEventListener("click", () => purgeCache(service, statusEl, purgeBtn));

      row.appendChild(purgeBtn);
      actions.appendChild(row);

      actions.appendChild(statusEl);

      return actions;
    }

    async function purgeCache(service, statusEl, buttonEl) {
      const promptText =
        `Purge Cloudflare cache for ${service.name}?\n` +
        "Enter paths or URLs to purge (comma-separated). Leave blank to purge everything.\n" +
        "Note: purging may temporarily degrade performance and increase load on your origin.";

      const input = window.prompt(promptText, "");
      if (input === null) return;

      const payload = {};
      const trimmed = input.trim();
      if (trimmed) {
        const files = trimmed
          .split(",")
          .map((value) => value.trim())
          .filter(Boolean);
        if (files.length === 0) {
          statusEl.textContent = "No files provided.";
          statusEl.className = "action-status warn";
          return;
        }
        payload.files = files;
      } else {
        payload.purge_everything = true;
      }

      statusEl.className = "action-status";
      statusEl.textContent = "Purging cache...";
      buttonEl.disabled = true;
      try {
        await fetchJSON(`/services/${encodeURIComponent(service.name)}/purge-cache`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        statusEl.className = "action-status ok";
        statusEl.textContent = "Cache purged.";
      } catch (err) {
        statusEl.className = "action-status warn";
        statusEl.textContent = `Purge failed: ${err.message}`;
      } finally {
        buttonEl.disabled = false;
      }
    }

    // Safely escape HTML to prevent XSS
    function escapeHtml(str) {
      if (str == null) return "";
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function renderServices(list) {
      servicesContainer.innerHTML = "";
      if (!list || list.length === 0) {
        servicesContainer.innerHTML = '<div class="empty">No services yet. Add one from the CLI</div>';
        return;
      }

      for (const svc of list) {
        const serviceEl = document.createElement("div");
        serviceEl.className = "service";

        // Create elements safely using textContent
        const h3 = document.createElement("h3");
        h3.textContent = svc.name || "unnamed";

        const pillRow = document.createElement("div");
        pillRow.className = "pill-row";
        pillRow.style.marginBottom = "6px";

        const statusBadge = document.createElement("span");
        statusBadge.className = svc.status === "healthy" ? "badge ok" : "badge warn";
        statusBadge.textContent = svc.status || "pending";

        const typeBadge = document.createElement("span");
        typeBadge.className = "badge";
        typeBadge.textContent = svc.type || "registry-image";

        const enabledBadge = document.createElement("span");
        enabledBadge.className = svc.enabled ? "badge" : "badge warn";
        enabledBadge.textContent = svc.enabled ? "enabled" : "disabled";

        pillRow.appendChild(statusBadge);
        pillRow.appendChild(typeBadge);
        pillRow.appendChild(enabledBadge);

        const imageDiv = document.createElement("div");
        imageDiv.className = "inline-muted";
        imageDiv.textContent = "Image: " + (svc.image || "—");

        const portDiv = document.createElement("div");
        portDiv.className = "inline-muted";
        portDiv.textContent = "Port: " + (svc.internal_port || "—");

        const uptimeDiv = document.createElement("div");
        uptimeDiv.className = "inline-muted";
        uptimeDiv.textContent = "Uptime: " + (svc.uptime_seconds != null ? formatUptime(svc.uptime_seconds) : "—");

        const dataDiv = document.createElement("div");
        dataDiv.className = "inline-muted";
        dataDiv.textContent = "Data: " + (svc.data_bytes != null ? formatBytes(svc.data_bytes) : "—");

        const hostnames = svc.hostnames || [];
        if (hostnames.length > 0) {
          const hostsDiv = document.createElement("div");
          hostsDiv.className = "inline-muted";
          hostnames.forEach((h, i) => {
            const url = hostToUrl(h);
            const link = document.createElement(url ? "a" : "span");
            link.className = "host-link";
            link.textContent = url || h;
            if (url) {
              link.href = url;
              link.target = "_blank";
              link.rel = "noopener noreferrer";
            }
            hostsDiv.appendChild(link);
            if (i < hostnames.length - 1) {
              hostsDiv.appendChild(document.createTextNode(" / "));
            }
          });
          serviceEl.appendChild(hostsDiv);
        }

        serviceEl.appendChild(h3);
        serviceEl.appendChild(pillRow);
        serviceEl.appendChild(imageDiv);
        serviceEl.appendChild(portDiv);
        serviceEl.appendChild(uptimeDiv);
        serviceEl.appendChild(dataDiv);

        const actions = buildPurgeSection(svc);
        if (actions) {
          serviceEl.appendChild(actions);
        }

        servicesContainer.appendChild(serviceEl);
      }
    }

    function renderLogTags(services) {
      const accessSources = [
        { value: "ui", label: "UI access" },
        { value: "api", label: "API access" },
        { value: "webhook", label: "Webhook access" },
      ];
      const containerSources = [
        { value: "traefik", label: "traefik" },
        { value: "cloudflared", label: "cloudflared" },
        { value: "whoami", label: "whoami" },
      ];
      for (const svc of services || []) {
        if (svc && svc.name) {
          containerSources.push({ value: svc.name, label: svc.name });
        }
      }

      const available = new Set();
      accessTags.innerHTML = "";
      containerTags.innerHTML = "";

      function addTag(entry, target) {
        if (!entry.value) return;
        available.add(entry.value);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag";
        btn.textContent = entry.label || entry.value;
        btn.dataset.value = entry.value;
        if (entry.value === currentLogSource) {
          btn.classList.add("active");
        }
        btn.addEventListener("click", () => {
          currentLogSource = entry.value;
          document.querySelectorAll(".tag").forEach((el) => el.classList.remove("active"));
          btn.classList.add("active");
          loadLogs();
        });
        target.appendChild(btn);
      }

      for (const entry of accessSources) {
        addTag(entry, accessTags);
      }
      for (const entry of containerSources) {
        addTag(entry, containerTags);
      }

      if (!available.has(currentLogSource)) {
        currentLogSource = accessSources[0]?.value || containerSources[0]?.value || "";
        const active = document.querySelector(`.tag[data-value=\"${currentLogSource}\"]`);
        if (active) active.classList.add("active");
      }
    }

    async function loadLogs() {
      logsError.style.display = "none";
      const service = currentLogSource;
      if (!service) {
        logsOutput.textContent = "Select a log source.";
        return;
      }
      logsOutput.textContent = "Loading...";
      const params = new URLSearchParams();
      params.set("service", service);
      params.set("tail", String(currentTail));
      try {
        const res = await fetch(`/logs?${params.toString()}`, { cache: "no-store" });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        logsOutput.textContent = await res.text() || "(no logs)";
      } catch (err) {
        logsError.textContent = `Logs error: ${err.message}`;
        logsError.style.display = "block";
        logsOutput.textContent = "";
      }
    }

    async function loadDashboard() {
      statusError.style.display = "none";
      servicesError.style.display = "none";
      try {
        const status = await fetchJSON("/status");
        renderStatus(status);
      } catch (err) {
        statusError.textContent = `Status error: ${err.message}`;
        statusError.style.display = "block";
      }

      try {
        const services = await fetchJSON("/services?data=1");
        renderServices(services);
        renderLogTags(services);
        if (currentLogSource) {
          loadLogs();
        }
      } catch (err) {
        servicesError.textContent = `Services error: ${err.message}`;
        servicesError.style.display = "block";
      }
    }

    document.getElementById("refresh").addEventListener("click", loadDashboard);
    tailCountEl.textContent = String(currentTail);
    loadEarlierBtn.addEventListener("click", () => {
      currentTail += 200;
      tailCountEl.textContent = String(currentTail);
      loadLogs();
    });
    document.addEventListener("DOMContentLoaded", loadDashboard);

    function isHealthy(entry) {
      if (!entry || !entry.state) return false;
      if (entry.health && entry.health.toLowerCase() !== "healthy") return false;
      return entry.state.toLowerCase() === "running" || entry.state.toLowerCase() === "healthy";
    }

    const userInfoEl = document.getElementById("user-info");

    async function loadUserInfo() {
      try {
        const me = await fetchJSON("/me");
        if (me.authenticated && me.email) {
          // Use textContent to prevent XSS
          userInfoEl.textContent = "";
          const emailSpan = document.createElement("span");
          emailSpan.className = "email";
          emailSpan.textContent = me.email;
          userInfoEl.appendChild(emailSpan);
          userInfoEl.style.display = "flex";
        }
      } catch (err) {
        // Ignore - user info is optional
      }
    }

    document.addEventListener("DOMContentLoaded", loadUserInfo);
  </script>
</body>
</html>
