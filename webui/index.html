<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TinyServe dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #7c3aed;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --card: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(14,165,233,0.08));
      --border: rgba(255,255,255,0.06);
      --success: #22c55e;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "SF Pro Display", "Inter", "Helvetica Neue", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(124,58,237,0.12), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(14,165,233,0.18), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 24px 56px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 22px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(120deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow: 0 24px 60px rgba(0,0,0,0.25);
    }
    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.02em;
    }
    .title p {
      margin: 0;
      color: var(--muted);
    }
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      font-size: 13px;
      color: var(--muted);
    }
    .user-info .email {
      color: var(--text);
    }
    button {
      cursor: pointer;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
      background: var(--accent);
      color: #f8fafc;
      font-weight: 600;
      letter-spacing: -0.01em;
      box-shadow: 0 10px 32px rgba(124,58,237,0.35);
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button:active { transform: translateY(1px); box-shadow: 0 6px 20px rgba(124,58,237,0.25); }
    .section {
      margin-top: 24px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      padding: 18px 18px 12px;
      box-shadow: 0 22px 50px rgba(0,0,0,0.2);
    }
    .section h2 {
      margin: 4px 0 12px;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(17,24,39,0.7);
      padding: 12px 14px;
    }
    .metric {
      font-size: 28px;
      font-weight: 700;
    }
    .metric.ok { color: var(--success); }
    .metric.warn { color: var(--warning); }
    .label {
      color: var(--muted);
      font-size: 13px;
      margin-top: 2px;
    }
    .muted { color: var(--muted); }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
    }
    .badge.ok { color: var(--success); border-color: rgba(34,197,94,0.5); }
    .badge.warn { color: var(--warning); border-color: rgba(245,158,11,0.5); }
    .services {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 6px;
    }
    .service {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(17,24,39,0.8);
      padding: 14px;
    }
    .service h3 {
      margin: 0 0 6px;
      font-size: 17px;
      letter-spacing: -0.01em;
    }
    .pill-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .inline-muted { color: var(--muted); font-size: 13px; }
    .empty {
      text-align: center;
      color: var(--muted);
      padding: 24px 12px;
    }
    .error {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(248,113,113,0.5);
      background: rgba(248,113,113,0.08);
      color: #fecdd3;
      display: none;
    }
    .log-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    select,
    input[type="number"] {
      background: rgba(17,24,39,0.8);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
    }
    .logs-output {
      background: rgba(2,6,23,0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-height: 120px;
      max-height: 320px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .tail-buttons {
      display: flex;
      gap: 4px;
    }
    .tail-btn {
      background: rgba(17,24,39,0.8);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    .tail-btn.active {
      background: rgba(99, 102, 241, 0.3);
      border-color: rgba(99, 102, 241, 0.6);
    }
    .tail-btn:hover {
      background: rgba(99, 102, 241, 0.2);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title">
        <h1>tinyserve</h1>
        <p>Local Mac mini host — Traefik + cloudflared front door</p>
      </div>
      <div class="actions">
        <div id="user-info" class="user-info" style="display: none;"></div>
        <button id="refresh">Refresh</button>
      </div>
    </header>

    <div class="section">
      <h2>Daemon status</h2>
      <div class="grid">
        <div class="card">
          <div class="metric" id="status-text">—</div>
          <div class="label">Status</div>
        </div>
        <div class="card">
          <div class="metric" id="service-count">0</div>
          <div class="label">Services tracked</div>
        </div>
        <div class="card">
          <div class="metric" id="updated-at">—</div>
          <div class="label">Last state update</div>
        </div>
        <div class="card">
          <div class="metric" id="proxy-status">—</div>
          <div class="label">Traefik</div>
          <div class="inline-muted" id="proxy-health">—</div>
        </div>
        <div class="card">
          <div class="metric" id="tunnel-status">—</div>
          <div class="label">cloudflared</div>
          <div class="inline-muted" id="tunnel-health">—</div>
        </div>
        <div class="card">
          <div class="metric" id="uptime">—</div>
          <div class="label">Uptime</div>
        </div>
        <div class="card">
          <div class="metric" id="free-disk">—</div>
          <div class="label">Free disk</div>
        </div>
      </div>
      <div class="error" id="status-error"></div>
    </div>

    <div class="section">
      <h2>Services</h2>
      <div id="services" class="services"></div>
      <div class="error" id="services-error"></div>
    </div>

    <div class="section">
      <h2>Logs</h2>
      <div class="log-controls">
        <select id="logs-service"></select>
        <div class="tail-buttons">
          <button class="tail-btn" data-tail="50">50</button>
          <button class="tail-btn active" data-tail="200">200</button>
          <button class="tail-btn" data-tail="500">500</button>
          <button class="tail-btn" data-tail="1000">1000</button>
        </div>
      </div>
      <pre id="logs-output" class="logs-output">Select a source and load logs.</pre>
      <div class="error" id="logs-error"></div>
    </div>
  </div>

  <script>
    const statusText = document.getElementById("status-text");
    const serviceCount = document.getElementById("service-count");
    const updatedAt = document.getElementById("updated-at");
    const servicesContainer = document.getElementById("services");
    const statusError = document.getElementById("status-error");
    const servicesError = document.getElementById("services-error");
    const proxyStatus = document.getElementById("proxy-status");
    const proxyHealth = document.getElementById("proxy-health");
    const tunnelStatus = document.getElementById("tunnel-status");
    const tunnelHealth = document.getElementById("tunnel-health");
    const uptimeEl = document.getElementById("uptime");
    const freeDiskEl = document.getElementById("free-disk");
    const logsService = document.getElementById("logs-service");
    const logsOutput = document.getElementById("logs-output");
    const logsError = document.getElementById("logs-error");
    const tailButtons = document.querySelectorAll(".tail-btn");
    let currentTail = 200;

    async function fetchJSON(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || res.statusText);
      }
      return res.json();
    }

    function renderStatus(data) {
      statusText.textContent = data.status || "unknown";
      statusText.className = data.status === "ok" ? "metric ok" : "metric warn";
      serviceCount.textContent = data.service_count ?? 0;
      updatedAt.textContent = data.updated_at ? new Date(data.updated_at).toLocaleString() : "—";
      const proxy = data.proxy || {};
      proxyStatus.textContent = proxy.state || "unknown";
      proxyStatus.className = isHealthy(proxy) ? "metric ok" : "metric warn";
      proxyHealth.textContent = proxy.health || "";

      const tunnel = data.tunnel || {};
      tunnelStatus.textContent = tunnel.state || "unknown";
      tunnelStatus.className = isHealthy(tunnel) ? "metric ok" : "metric warn";
      tunnelHealth.textContent = tunnel.health || "";

      uptimeEl.textContent = data.uptime_seconds != null ? formatUptime(data.uptime_seconds) : "—";
      freeDiskEl.textContent = data.free_disk_bytes != null ? formatBytes(data.free_disk_bytes) : "—";
    }

    function formatUptime(seconds) {
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (d > 0) return `${d}d ${h}h`;
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      return (bytes / (1024 * 1024 * 1024)).toFixed(1) + " GB";
    }

    // Safely escape HTML to prevent XSS
    function escapeHtml(str) {
      if (str == null) return "";
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function renderServices(list) {
      servicesContainer.innerHTML = "";
      if (!list || list.length === 0) {
        servicesContainer.innerHTML = '<div class="empty">No services yet. Add one from the CLI</div>';
        return;
      }

      for (const svc of list) {
        const serviceEl = document.createElement("div");
        serviceEl.className = "service";

        // Create elements safely using textContent
        const h3 = document.createElement("h3");
        h3.textContent = svc.name || "unnamed";

        const pillRow = document.createElement("div");
        pillRow.className = "pill-row";
        pillRow.style.marginBottom = "6px";

        const statusBadge = document.createElement("span");
        statusBadge.className = svc.status === "healthy" ? "badge ok" : "badge warn";
        statusBadge.textContent = svc.status || "pending";

        const typeBadge = document.createElement("span");
        typeBadge.className = "badge";
        typeBadge.textContent = svc.type || "registry-image";

        const enabledBadge = document.createElement("span");
        enabledBadge.className = svc.enabled ? "badge" : "badge warn";
        enabledBadge.textContent = svc.enabled ? "enabled" : "disabled";

        pillRow.appendChild(statusBadge);
        pillRow.appendChild(typeBadge);
        pillRow.appendChild(enabledBadge);

        const imageDiv = document.createElement("div");
        imageDiv.className = "inline-muted";
        imageDiv.textContent = "Image: " + (svc.image || "—");

        const portDiv = document.createElement("div");
        portDiv.className = "inline-muted";
        portDiv.textContent = "Port: " + (svc.internal_port || "—");

        const hostsDiv = document.createElement("div");
        hostsDiv.className = "inline-muted";
        hostsDiv.appendChild(document.createTextNode("Hosts: "));

        const hostnames = svc.hostnames || [];
        if (hostnames.length === 0) {
          hostsDiv.appendChild(document.createTextNode("—"));
        } else {
          hostnames.forEach((h, i) => {
            const badge = document.createElement("span");
            badge.className = "badge";
            badge.textContent = h;
            hostsDiv.appendChild(badge);
            if (i < hostnames.length - 1) {
              hostsDiv.appendChild(document.createTextNode(" "));
            }
          });
        }

        serviceEl.appendChild(h3);
        serviceEl.appendChild(pillRow);
        serviceEl.appendChild(imageDiv);
        serviceEl.appendChild(portDiv);
        serviceEl.appendChild(hostsDiv);

        servicesContainer.appendChild(serviceEl);
      }
    }

    function renderLogOptions(services) {
      const current = logsService.value;
      logsService.innerHTML = "";
      const builtins = [
        { value: "ui", label: "UI access" },
        { value: "api", label: "API access" },
        { value: "webhook", label: "Webhook access" },
        { value: "traefik", label: "traefik (container)" },
        { value: "cloudflared", label: "cloudflared (container)" },
        { value: "whoami", label: "whoami (container)" },
      ];
      for (const entry of builtins) {
        const opt = document.createElement("option");
        opt.value = entry.value;
        opt.textContent = entry.label;
        logsService.appendChild(opt);
      }
      for (const svc of services || []) {
        const opt = document.createElement("option");
        opt.value = svc.name || "";
        opt.textContent = `${svc.name || "unnamed"} (service)`;
        logsService.appendChild(opt);
      }
      if (current) {
        logsService.value = current;
      } else {
        logsService.value = "ui";
      }
    }

    async function loadLogs() {
      logsError.style.display = "none";
      const service = logsService.value;
      if (!service) {
        logsOutput.textContent = "Select a log source.";
        return;
      }
      logsOutput.textContent = "Loading...";
      const params = new URLSearchParams();
      params.set("service", service);
      params.set("tail", String(currentTail));
      try {
        const res = await fetch(`/logs?${params.toString()}`, { cache: "no-store" });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        logsOutput.textContent = await res.text() || "(no logs)";
      } catch (err) {
        logsError.textContent = `Logs error: ${err.message}`;
        logsError.style.display = "block";
        logsOutput.textContent = "";
      }
    }

    async function loadDashboard() {
      statusError.style.display = "none";
      servicesError.style.display = "none";
      try {
        const status = await fetchJSON("/status");
        renderStatus(status);
      } catch (err) {
        statusError.textContent = `Status error: ${err.message}`;
        statusError.style.display = "block";
      }

      try {
        const services = await fetchJSON("/services");
        renderServices(services);
        renderLogOptions(services);
      } catch (err) {
        servicesError.textContent = `Services error: ${err.message}`;
        servicesError.style.display = "block";
      }
    }

    document.getElementById("refresh").addEventListener("click", loadDashboard);
    logsService.addEventListener("change", loadLogs);
    tailButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        tailButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentTail = parseInt(btn.dataset.tail, 10);
        loadLogs();
      });
    });
    document.addEventListener("DOMContentLoaded", loadDashboard);

    function isHealthy(entry) {
      if (!entry || !entry.state) return false;
      if (entry.health && entry.health.toLowerCase() !== "healthy") return false;
      return entry.state.toLowerCase() === "running" || entry.state.toLowerCase() === "healthy";
    }

    const userInfoEl = document.getElementById("user-info");

    async function loadUserInfo() {
      try {
        const me = await fetchJSON("/me");
        if (me.authenticated && me.email) {
          // Use textContent to prevent XSS
          userInfoEl.textContent = "";
          const emailSpan = document.createElement("span");
          emailSpan.className = "email";
          emailSpan.textContent = me.email;
          userInfoEl.appendChild(emailSpan);
          userInfoEl.style.display = "flex";
        }
      } catch (err) {
        // Ignore - user info is optional
      }
    }

    document.addEventListener("DOMContentLoaded", loadUserInfo);
  </script>
</body>
</html>
