name: Brew Release (macOS arm64)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.1.0)"
        required: true
      tap:
        description: "Homebrew tap repo (owner/homebrew-tap). Leave empty to use secret HOMEBREW_TAP."
        required: false
      formula_path:
        description: "Formula path in tap repo"
        required: false
        default: "Formula/tinyserve.rb"
      update_tap:
        description: "Update Homebrew tap"
        type: boolean
        default: true
      publish_release:
        description: "Upload release assets to GitHub Releases"
        type: boolean
        default: true

jobs:
  brew-release:
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Resolve release vars
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          if [ -z "$TAG" ]; then
            echo "Missing tag; provide inputs.tag for workflow_dispatch."
            exit 1
          fi
          VERSION="${TAG#v}"
          TARBALL="tinyserve_${VERSION}_darwin_arm64.tar.gz"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"

      - name: Build binaries
        run: |
          set -euo pipefail
          mkdir -p dist
          VERSION="${{ steps.vars.outputs.version }}"
          COMMIT="${{ github.sha }}"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          LDFLAGS="-s -w -X tinyserve/internal/version.Version=${VERSION} -X tinyserve/internal/version.Commit=${COMMIT:0:7} -X tinyserve/internal/version.Date=${DATE}"
          GOOS=darwin GOARCH=arm64 go build -trimpath -ldflags "$LDFLAGS" -o dist/tinyserve ./cmd/tinyserve
          GOOS=darwin GOARCH=arm64 go build -trimpath -ldflags "$LDFLAGS" -o dist/tinyserved ./cmd/tinyserved

      - name: Package tarball
        run: |
          set -euo pipefail
          cd dist
          tar -czf "${{ steps.vars.outputs.tarball }}" tinyserve tinyserved
          shasum -a 256 "${{ steps.vars.outputs.tarball }}" | awk '{print $1}' > "${{ steps.vars.outputs.tarball }}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tinyserve-darwin-arm64
          path: |
            dist/${{ steps.vars.outputs.tarball }}
            dist/${{ steps.vars.outputs.tarball }}.sha256

      - name: Publish GitHub Release assets
        if: ${{ github.event_name == 'push' || inputs.publish_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          files: |
            dist/${{ steps.vars.outputs.tarball }}
            dist/${{ steps.vars.outputs.tarball }}.sha256

      - name: Check tap configuration
        id: tap
        env:
          TAP_INPUT: ${{ inputs.tap }}
          TAP_SECRET: ${{ secrets.HOMEBREW_TAP }}
        run: |
          TAP="${TAP_INPUT:-$TAP_SECRET}"
          if [ -n "$TAP" ]; then
            echo "repo=$TAP" >> "$GITHUB_OUTPUT"
            echo "configured=true" >> "$GITHUB_OUTPUT"
          else
            echo "configured=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout tap repo
        if: ${{ (github.event_name == 'push' || inputs.update_tap == 'true') && steps.tap.outputs.configured == 'true' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.tap.outputs.repo }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update tap formula
        if: ${{ (github.event_name == 'push' || inputs.update_tap == 'true') && steps.tap.outputs.configured == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          FORMULA_PATH="${{ inputs.formula_path }}"
          if [ -z "$FORMULA_PATH" ]; then
            FORMULA_PATH="Formula/tinyserve.rb"
          fi
          SHA="$(cat "dist/${{ steps.vars.outputs.tarball }}.sha256")"
          URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.vars.outputs.tag }}/${{ steps.vars.outputs.tarball }}"

          cat > "tap/${FORMULA_PATH}" <<EOF
          class Tinyserve < Formula
            desc "Local host manager for a single Mac mini running small Docker services"
            homepage "https://github.com/${{ github.repository }}"
            url "$URL"
            sha256 "$SHA"
            version "${{ steps.vars.outputs.version }}"

            def install
              bin.install "tinyserve"
              bin.install "tinyserved"
            end
          end
          EOF

          cd tap
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git add "$FORMULA_PATH"
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
            commit -m "tinyserve ${{ steps.vars.outputs.version }}"
          git push
